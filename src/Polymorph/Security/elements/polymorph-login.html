<!--suppress HtmlUnknownTarget, JSUnresolvedFunction, JSUnusedGlobalSymbols -->
<link rel="import" href="../../../../../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html"/>
<link rel="import" href="../../../../../../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../../../../../../bower_components/iron-collapse/iron-collapse.html"/>
<link rel="import" href="../../../../../../bower_components/iron-ajax/iron-ajax.html"/>

<dom-module id="polymorph-login">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            form {
                max-width: 200px;
                margin: 0 auto;
            }

            paper-button {
                display: block;
                margin: 16px 0 0 0;
                padding: 6px 8px;
                background-color: var(--polymorph-app-link-color);
                color: #fff;
            }

            .login-error {
                color: var(--polymorph-app-error-color);
                padding: 16px 8px;
                font-size: 0.85em;
                font-family: var(--polymorph-login-font, 'sans-serif');
            }

            #hidden-submit {
                display: none;
            }

        </style>

        <iron-ajax id="api" url="[[action]]" method="POST" handle-as="json" on-response="onResponse"></iron-ajax>

        <form name="login" id="login" method="POST" action="[[action]]" on-submit="onNativeSubmit">
            <input type="hidden" name="token" value="[[token]]"/>
            <input id="hidden-submit" type="submit"/>
            <paper-input name="username" label="[[usernameLabel]]" required autocomplete></paper-input>
            <paper-input name="password" label="[[passwordLabel]]" type="password" autocomplete></paper-input>
            <iron-collapse id="failed">
                <div class="login-error">
                    [[errorText]]
                </div>
            </iron-collapse>
            <paper-button raised on-click="doLogin">[[buttonLabel]]</paper-button>
        </form>
    </template>

    <script>
        Polymer({

            is: 'polymorph-login',

            properties: {
                usernameLabel: {
                    type: String
                },
                passwordLabel: {
                    type: String
                },
                token: {
                    type: String,
                    value: ''
                },
                action: {
                    type: String,
                    value: window.base + 'login'
                },
                errorText: {
                    type: String,
                    value: 'login failed'
                },
                loginFailed: {
                    type: Boolean,
                    value: false,
                    notify: true
                }
            },

            onNativeSubmit: function (event) {
                event.preventDefault();
                clearTimeout(this.resetTO);
                this.doLogin();
            },

            onResponse: function () {
                var self = this;
                //noinspection JSUnresolvedVariable
                var response = this.$.api.lastResponse;

                if (response.success) {
                    window.location.reload(true);
                } else {
                    this.$.failed.set('opened', true);
                    this.resetTO = setTimeout(function () {
                        self.$.failed.set('opened', false);
                    }, 3000);
                }
            },

            doLogin: function () {
                var self = this;
                var fields = ['token', 'username', 'password'];
                var data = {};
                fields.forEach(function(fieldName) {
                    var $field = self.$$('[name="' + fieldName + '"]');
                    data[fieldName] = $field.value;
                });
                //noinspection JSUnresolvedVariable
                this.$.api.set('params', data);
                //noinspection JSUnresolvedVariable
                this.$.api.generateRequest();
            }
        });
    </script>

</dom-module>
