<!--suppress HtmlUnknownTarget, JSUnresolvedFunction, JSUnusedGlobalSymbols
@see http://stackoverflow.com/q/2382329
@see http://stackoverflow.com/q/21191336
-->

<!-- elements -->
<link rel="import" href="../../../../../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html"/>
<link rel="import" href="../../../../../../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../../../../../../bower_components/iron-collapse/iron-collapse.html"/>
<link rel="import" href="../../../../../../bower_components/iron-ajax/iron-ajax.html"/>

<!-- global styles -->
<style>
    #fake-login{
        position: fixed;
        left: 200%;
    }
</style>

<dom-module id="polymorph-login">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            form {
                max-width: 200px;
                margin: 0 auto;
            }

            #fake-login{
                position: fixed;
                left: 200%;
            }

            paper-button {
                display: block;
                margin: 16px 0 0 0;
                padding: 6px 8px;
                color: #fff;
                background-color: var(--polymorph-login-primary-color);
            }

            /*noinspection CssUnusedSymbol*/
            .login-error {
                color: var(--polymorph-login-error-color);
                padding: 16px 8px;
                font-size: 0.85em;
                font-family: var(--polymorph-login-font, 'sans-serif');
            }

        </style>


        <form name="fake-login" id="fake-login" method="POST" action="" on-submit="onFakeSubmit">
            <!--suppress HtmlFormInputWithoutLabel -->
            <input name="username" value="{{username}}" type="text" autocomplete />
            <!--suppress HtmlFormInputWithoutLabel -->
            <input name="password" value="{{password}}" type="password" autocomplete />
            <input id="fake-login-submit" type="submit" value="login"/>
        </form>

        <form name="login" id="login" method="POST" action="[[action]]" on-submit="onSubmit">
            <input type="hidden" name="token" value="[[token]]"/>
            <paper-input name="username" value="{{username}}" label="[[usernameLabel]]" required autocomplete></paper-input>
            <paper-input name="password" value="{{password}}"  label="[[passwordLabel]]" type="password" autocomplete="current-password"></paper-input>

            <iron-collapse id="failed">
                <div class="login-error">
                    [[errorText]]
                </div>
            </iron-collapse>
            <paper-button raised on-click="doLogin">[[buttonLabel]]</paper-button>
        </form>

        <iron-ajax id="api" url="[[action]]" method="POST" handle-as="json" on-response="onResponse"></iron-ajax>
    </template>

    <script>
        Polymer({

            is: 'polymorph-login',

            properties: {
                base: {
                    type: String,
                    value: window.base
                },
                usernameLabel: {
                    type: String
                },
                passwordLabel: {
                    type: String
                },
                token: {
                    type: String,
                    value: ''
                },
                action: {
                    type: String,
                    value: window.location.href
                },
                errorText: {
                    type: String,
                    value: 'login failed'
                },
                loginFailed: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                targetHref: {
                    type: String,
                    value: window.base
                }
            },

            ready: function () {
                this.$form = this.$$('#login');
                this.$fakeForm = this.$$('#fake-login');
                this.moveFakeForm();
                this.activateForm();
            },

            /**
             * Moves the `fake-login` form out of shadow dom, so that Chrome can save and restore the password
             */
            moveFakeForm: function () {
                this.async(function () {
                    Polymer.dom(this).parentNode.appendChild(this.$fakeForm);
                }, 500);
            },

            activateForm: function () {
                var self = this;
                var $username = this.$form.querySelector('[name="username"]');
                var $fakeUsername = this.$fakeForm.querySelector('[name="username"]');
                // submit form on ENTER
                this.addEventListener("keypress", function(event) {
                    if (event.keyCode === 13) {
                        self.doLogin();
                    }
                }, false);
                this.async(function () {
                    // inherit saved password
                    $username.value = $fakeUsername.value;
                    // focus username field
                    $username.focus();
                }, 1000);
            },

            onSubmit: function (event) {
                event.preventDefault();
                clearTimeout(this.resetTO);
                this.doLogin();
            },

            onFakeSubmit: function (event) {
                event.preventDefault();
            },

            doLogin: function () {
                this.debounce('doLogin', function () {
                    var body = this.getLoginRequestBody();
                    //noinspection JSUnresolvedVariable
                    this.$.api.set('body', body);
                    //noinspection JSUnresolvedVariable
                    this.$.api.generateRequest();
                }, 100);
            },

            getLoginRequestBody: function () {
                var self = this;
                var params = [];
                var fields = ['token', 'username', 'password'];
                fields.forEach(function(fieldName) {
                    var fieldValue = self.$form.querySelector('[name="' + fieldName + '"]').value;
                    params.push(encodeURIComponent(fieldName) + '=' +  encodeURIComponent(fieldValue));
                });
                return params.join('&');
            },

            onResponse: function () {
                //noinspection JSUnresolvedVariable
                var response = this.$.api.lastResponse;
                if (!response) {
                    return;
                }
                if (response.success) {
                    this.onSuccess();
                } else {
                    this.onFail();
                }
            },

            onSuccess: function () {
                // trigger password-saving in non-chrome browsers
                this.$fakeForm.querySelector('#fake-login-submit').click();
                // trigger password-saving in chrome
                window.location.href = this.base + this.targetHref.replace(/^\/+/, '');
            },

            onFail: function () {
                var self = this;
                // show error message for 3 seconds
                this.$.failed.set('opened', true);
                this.resetTO = setTimeout(function () {
                    self.$.failed.set('opened', false);
                }, 3000);
            }
        });
    </script>

</dom-module>
