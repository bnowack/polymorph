<!-- polymorph-page -->

<dom-module id="polymorph-page">
    <template>
        <style include="shared-styles">
            :host {
                @apply(--polymorph-page);
            }

            :host ::content {
            }
        </style>

        <content></content>
    </template>

    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({

            is: 'polymorph-page',

            properties: {
                /**
                 * View path of this partial
                 */
                path: {
                    type: String,
                    reflectToAttribute: true
                },
                element: String,
                elementData: Object
            },

            attached: function () {
                this.checkElement();
                this.listen(document.body.querySelector('polymorph-app'), 'polymorph-page.loaded', 'onLoaded');
            },

            detached: function () {
                this.unlisten(document.body.querySelector('polymorph-app'), 'polymorph-page.loaded', 'onLoaded');
            },

            /**
             * Replaces the partial contents
             *
             * @param event Polymer event
             * @param data Event data with field `$partial`
             */
            onLoaded: function (event, data) {
                /** @type {HTMLElement} */
                var $partial = data.$partial;
                // set properties (can't use $partial.PROPERTY because the partial is not initialized in this context)
                this.set('path', $partial.getAttribute('path'));
                this.set('element', $partial.getAttribute('element'));
                this.set('elementData', JSON.parse($partial.getAttribute('element-data')));
                // replace all contents
                Polymer.dom(this).innerHTML = $partial.innerHTML;
                // activate script tags
                Polymer.dom(this).querySelectorAll('script').forEach(function (script) {
                    eval(script.innerHTML);
                });
                this.checkElement();
            },

            /**
             * Checks if a to-be-appended element is defined
             */
            checkElement: function () {
                if (this.element) {
                    this.importHref(this.element, this.appendElement);
                }
            },

            /**
             * Appends an element defined as property
             */
            appendElement: function () {
                var elementName = this.element.replace(/^.*\/([^\/]+)\.html.*$/, '$1');
                var $element = document.createElement(elementName);
                Polymer.dom(this).appendChild($element);
                // set element data
                var elementData = this.elementData || {};
                for (var name in elementData) {
                    if (elementData.hasOwnProperty(name)) {
                        $element.set(name, elementData[name]);
                    }
                }
            }
        });

    </script>

</dom-module>
